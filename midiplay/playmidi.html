<!DOCTYPE HTML>
<!-- Based on https://github.com/gasman/jasmid  -->
<html>
	<head>
	  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<script src="jasmid/stream.js"></script>
		<script src="jasmid/midifile.js"></script>
		<script src="jasmid/replayer.js"></script>
		<script src="jasmid/synth.js"></script>
		<script src="jasmid/audio.js"></script>
		<script>
			function loadRemote(path, callback) {
				var fetch = new XMLHttpRequest();
				fetch.open('GET', path);
				fetch.overrideMimeType("text/plain; charset=x-user-defined");
				fetch.onreadystatechange = function() {
					if(this.readyState == 4 && this.status == 200) {
						/* munge response into a binary string */
						var t = this.responseText || "" ;
						var ff = [];
						var mx = t.length;
						var scc= String.fromCharCode;
						for (var z = 0; z < mx; z++) {
							ff[z] = scc(t.charCodeAt(z) & 255);
						}
						callback(ff.join(""));
					}
				}
				fetch.send();
			}
			
			function play(file) {
				loadRemote(file, function(data) {
					midiFile = MidiFile(data);
					synth = Synth(44100);
					replayer = Replayer(midiFile, synth);
					audio = AudioPlayer(replayer);
				})
			}

			if(FileReader){
				function cancelEvent(e){
					e.stopPropagation();
					e.preventDefault();
				}
				document.addEventListener('dragenter', cancelEvent, false);
				document.addEventListener('dragover', cancelEvent, false);
				document.addEventListener('drop', function(e){
					cancelEvent(e);
					for(var i=0;i<e.dataTransfer.files.length;++i){
						var
							file = e.dataTransfer.files[i]
						;
						if(file.type != 'audio/midi'){
							continue;
						}
						var
							reader = new FileReader()
						;
						reader.onload = function(e){
							midiFile = MidiFile(e.target.result);
							synth = Synth(44100);
							replayer = Replayer(midiFile, synth);
							audio = AudioPlayer(replayer);
						};
						reader.readAsBinaryString(file);
					}
				}, false);
			}
		</script>

<!-- The rest is by DaveRo -->

<script>

  function fileExists(file_url){
    var http = new XMLHttpRequest();
    http.open('HEAD', file_url, false);
    http.send();
    return http.status != 404;
  }

<!-- Plays the file specified with ?URL=....  -->
  midiURL = document.URL.match(/\?URL=.*$/)
  if (midiURL == null){
    document.write("Error: No midi file URL specified") ;
    }

  else {
    midiURL = midiURL[0].substr(5) ;
    if (fileExists(midiURL)) {
      playButton = document.createElement("button") ;
      playButton.id = "playbutton" ;
      playButton.style.display = "block" ;
      playButton.textContent = "Click to play" ;
<!-- Need a user interaction for some browsers  -->
      playButton.addEventListener("click", function (){  
        play(midiURL) ;        
        playButton.style.display = "none" ;
        messageLine = document.getElementsByTagName("p")[0] ;
        messageLine.textContent =  "Playing: " + midiURL ;      
      })
<!-- Wait for the DOM to load before adding button  -->
      window.addEventListener('DOMContentLoaded', (e) => {
        content = document.getElementsByTagName("div") ;
        content[0].appendChild(playButton) ;
      });      

    } else {
      document.write("URL specified: " + midiURL + "<br>");
    	document.write("Error: File does not exist or cannot be accessed") ;
    }
  }
</script>
</head>
<body>
</body>
  <div id="content">
  <p id="message"></p>
  </div>
</html>
